{% extends 'base/base.html' %}
{% block title %}{{ place.place_name }} - ë¦¬ë·° í˜ì´ì§€{% endblock %}
{% load static %}
{% block content %}

<div class="container">
    <div class="left-content">
        <div id="left-box">
            {% for photo in profile_photo %}
            <img id="place_img" src="{{ photo }}" alt="{{ photo }}" onerror="this.onerror=null; this.src='{% static 'img/default1.png' %}';">
            {% endfor %}
            <div id="map" class="map" onclick="openMapModal()"></div> <!-- í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ -->
            <div id="mapModalContainer" class="hidden">
                <div id="mapModalContent">
                    <div id="largeMap" class="map"></div> <!-- í° ì§€ë„ë¥¼ í‘œì‹œí•  ê³µê°„ -->
                    <button class="overlay-button" onclick="closeMapModal()" style="color : #000000">&#10006;</button> <!-- ë‹«ê¸° ë²„íŠ¼ -->
                </div>
            </div>
            <div class = "address">
            <h2 id="place-name">{{ place.place_name }}</h2>   
            <p>ğŸ—ºï¸{{ place.place_address }}</p>
            </div>
            <a href="{{ place.place_place_url }}">{{ place.place_place_url }}</a>
            {% if total %}
                {% if lang == 'kor' %}
                <p class = "profile">ğŸš©  {{ kor_place_tag }}</p>
                {% else %}
                <p class = "profile">ğŸš©  {{ eng_place_tag }}</p>
                {% endif %}
                {% if lang == 'kor' %}
                <p class = "profile">ğŸ“ ë¦¬ë·° {{ total }}ê°œ</p>
                {% else %}
                <p class = "profile">ğŸ“ {{ total }} reviews</p>
            {% endif %}
            {% endif %}
            {% if place.place_operating_hours %}
                <p class = "profile" style="white-space: pre-line;">â° {{ place.place_operating_hours }}</p>
            {% endif %}
            {% if place.place_phone %}
                <p class = "profile">ğŸ“ {{ place.place_phone }}</p>
            {% endif %}
            {% if place.place_entrance_fee %}
                <p class = "profile">ğŸª™ {{ place.place_entrance_fee }}</p>
            {% endif %}
            <p>{{ place.place_place_desc }}</p>
        </div>
    </div>
    
    <div class="right-content">
        <div id="right-box">
            {% if thema_name or first_key %}
            <div class="theme-header">
                <div class="tag-box">
                    {% if thema_name %}
                    <span class="tag_name">í…Œë§ˆ</span>
                    {% for theme in thema_name %}
                    <span class="tag">{{ theme }}</span>
                    {% endfor %}
                    {% endif %}
                </div>
                <div class="dropdown">
                    {% if first_key %}
                    <!-- ì²« ë²ˆì§¸ í•­ëª©ì„ ì„ íƒëœ ê²ƒì²˜ëŸ¼ ë¯¸ë¦¬ í‘œì‹œ -->
                    <span class="keyword">í‚¤ì›Œë“œ</span>
                    <!-- ë‚˜ë¨¸ì§€ í•­ëª©ì€ <select> ì•ˆì— ë„£ìŒ -->
                    <select id="feature-select">
                            <option disabled selected hidden>{{first_key}}: {{first_value}}</option>
                        {% for key, value in feature_dict.items %}
                            {% if not forloop.first %} <!-- ì²« ë²ˆì§¸ í•­ëª©ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ í•­ëª©ë§Œ í‘œì‹œ -->
                            <option disabled>{{ key }}: {{ value }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            <div class = "tag_container">
                {% if lang == 'kor' %}
                <div class="explain">
                    ğŸ”‘ í•´ë‹¹ ë¦¬ë·°ëŠ” AI ë¶„ì„ì— ë”°ë¼ ê´‘ê³ ì„± ë¦¬ë·° ì œê±° í›„ ê° ê¸°ì¤€ë³„ ë†’ì€ ì ìˆ˜ ìˆœì„œë¡œ ì •ë ¬í•œ ë¦¬ë·° ë°ì´í„°ì…ë‹ˆë‹¤.
                </div>
                {% else %}
                <div class="explain">
                    ğŸ”‘ These reviews are sorted by highest scores per criterion after AI-based removal of promotional content.
                </div>
                {% endif %}
                <div class="filter-buttons">
                    {% if lang == 'kor' %}
                    <p>ì •ë ¬ ë°©ì‹</p>
                    <button onclick="loadReviews('latest')">ìµœì‹ ìˆœ âŒ›</button>
                    <button onclick="loadReviews('positive')">ê¸ì • ğŸ‘</button>
                    <button onclick="loadReviews('negative')">ë¶€ì • ğŸ‘</button>
                    {% else %}
                    <p style="padding: 0px; font-weight: normal;" >Sorted by</p>
                    <button onclick="loadReviews('latest')" style="width: 90px;">latest âŒ›</button>
                    <button onclick="loadReviews('positive')" style="width: 100px;">positive ğŸ‘</button>
                    <button onclick="loadReviews('negative')" style="width: 100px;">negative ğŸ‘</button>
                    {% endif %}
                </div>
            </div>
            <div id="review_container" class="cards">
                {% for review in reviews %}
                    <div class="card">
                        <img class="review-image" src="{{ review.review_photo }}" alt="{% static 'img/default1.png' %}" onclick="openModal('{{ review.review_photo }}')" onerror="this.onclick=null; this.onerror=null; this.src='{% static 'img/default1.png' %}';">
                        <img class="icon-overlay" src="{% static 'img/enlarge.png' %}">
                        <div class="card-content">
                            <p class="card-date">{{ review.review_date|date:"Y-m-d" }}</p>
                            {% if lang == 'kor' %}
                                {% if review.daily_tag_name %}
                                    <p class="card-daily">ë°©ë¬¸ ëª©ì : {{ review.daily_tag_name }}</p>
                                {% endif %}
                                {% if review.with_tag_name %}
                                    <p class="card-with">í•¨ê»˜ ë°©ë¬¸: {{ review.with_tag_name }}</p>
                                {% endif %}
                            {% else %}
                                {% if review.daily_tag_name %}
                                    <p class="card-daily">Purpose of Visit: {{ review.daily_tag_name }}</p>
                                {% endif %}
                                {% if review.with_tag_name %}
                                    <p class="card-with">Type of Visit: {{ review.with_tag_name }}</p>
                            {% endif %}
                            {% endif %}
                            {% if lang == 'kor' %}
                            <p class="card-description">{{ review.kor_review_text }}</p>
                            {% else %}
                            <p class="card-description">{{ review.eng_review_text }}</p>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="modalContainer" class="hidden">
    <div id="modalContent">
        <!-- <button id="modalCloseButton">ë‹«ê¸°</button> -->
        <img id="modalImage" src="" alt="Review Image">
        <button class="overlay-button" onclick="closeModal()">&#10006;</button>
    </div>
</div>




    {% endblock %}

    {% block extra_css %}
    
    <style>
    .cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0px;
    scrollbar-width: none;
    -ms-overflow-style: none;
    }

    .card {
        display: flex;
        flex-direction: row;
        background: white;
        padding: 10px 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        justify-content: flex-start;
        align-items: flex-start; /* ì•„ì´í…œë“¤ì„ ìƒë‹¨ì— ì •ë ¬ */
        gap: 15px;
        margin: 10px;
        transition: transform 0.2s ease-in-out; /* í˜¸ë²„ ì‹œ í™•ëŒ€ íš¨ê³¼ */
    }

    .card:hover {
        transform: scale(1.03); /* ì‚´ì§ í™•ëŒ€ */
    }

    .card img {
        width: 25%;
        height: auto; /* ë†’ì´ëŠ” ìë™ìœ¼ë¡œ ì„¤ì • */
        aspect-ratio: 1 / 1;
        border-radius: 10px;}

    .card-content {
        flex: 1; /* ë‚´ìš©ì´ ë‚˜ë¨¸ì§€ ê³µê°„ì„ ì±„ìš°ë„ë¡ */
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
    }

    .card-title {
        font-size: 1.2em;
        margin: 5px 0px ;
    }

    .card-date,.card-daily,.card-with {
        font-size: 0.8em;
        color: gray;
        margin: 5px 0px;
    }

    .card-description {
        font-size: 0.9em;
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto; /* í‘¸í„°ê°€ ë‚´ìš©ì˜ í•˜ë‹¨ì— ìœ„ì¹˜í•˜ë„ë¡ */
    }
    .right-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        width: 50%;
    }
    
    #mapModalContainer {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }
    
    #mapModalContent {
        width: 80%;
        height: 80%;
        background-color: transparent; /* ë°°ê²½ ìƒ‰ìƒì„ íˆ¬ëª…í•˜ê²Œ ì²˜ë¦¬í•˜ì—¬ ì§€ë„ê°€ ì „ì²´ë¥¼ ì±„ìš°ë„ë¡ ì„¤ì • */
        position: relative;
    }
    
    #largeMap {
        width: 100%;
        height: 100%;
        border-radius: 10px;
    }
    
    
    #mapModalContainer.hidden {
        display: none;
    }
    
    </style>
    <!-- ì´ í˜ì´ì§€ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” CSS -->
    <link rel="stylesheet" href="{% static 'css/review/style.css' %}">
    {% endblock %}
    
    
    {% block extra_js %}
    <script>
        const place_lat = {{place.place_lat}};
        const place_lon = {{place.place_lon}};
        const place_id = {{place.place_id}};
        let sort_array = '{{array}}';
        const marker_img = "{% static 'img/marker_img.png' %}";
        const current_page = {{current_page}};
        const total_pages = {{total_pages}};
    
    // ëª¨ë‹¬ ì—´ê¸° ê´€ë ¨ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
    function initModalEvents() {
        const modalOpenButtons = document.querySelectorAll('.review-image');
        modalOpenButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const imageSrc = e.target.getAttribute('src');
                openModal(imageSrc);
            });
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        initModalEvents();
    });
        
        // ëª¨ë‹¬ ì—´ê¸° ë° ë‹«ê¸°
    function openModal(imageSrc) {
            const modal = document.getElementById('modalContainer');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.remove('hidden');
        }
    
    function closeModal(){
        const modal = document.getElementById('modalContainer');
        modal.classList.add('hidden');
    }
    function openMapModal() {
    const mapModal = document.getElementById('mapModalContainer');
    mapModal.classList.remove('hidden');

    // í° ì§€ë„ í‘œì‹œ
    var largeMapOptions = {
        center: new naver.maps.LatLng(place_lat, place_lon), // ì¥ì†Œ ì¤‘ì‹¬ ìœ„ì¹˜
        zoom: 17
    };

    var largeMap = new naver.maps.Map('largeMap', largeMapOptions);

    var marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(place_lat, place_lon), // ë§ˆì»¤ ìœ„ì¹˜
        map: largeMap,
        icon: marker_img,
    });
    }
    
    function closeMapModal(){
        const mapModal = document.getElementById('mapModalContainer');
        mapModal.classList.add('hidden');
    }
    let reviewsData = []; // ì „ì²´ ë¦¬ë·° ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
    let filterByImage = false; // ì´ë¯¸ì§€ í•„í„° ì—¬ë¶€ë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¦¬ë·° ë°ì´í„°ë¥¼ ì„¸íŒ…í•˜ëŠ” í•¨ìˆ˜
    function SetReviews(reviews) {
        reviewsData = reviews; // ë¦¬ë·° ë°ì´í„°ë¥¼ ì €ì¥
        renderReviews(); // ì €ì¥ëœ ë¦¬ë·° ë°ì´í„°ë¥¼ ë Œë”ë§
    }
    
    // í•„í„°ë§ê³¼ ì •ë ¬ì„ í•¨ê»˜ ì ìš©í•œ ë¦¬ë·° ë Œë”ë§ í•¨ìˆ˜
    function renderReviews() {
        let filteredReviews = reviewsData;
    
        // ì´ë¯¸ì§€ í•„í„°ê°€ í™œì„±í™”ë˜ë©´ ì´ë¯¸ì§€ê°€ ìˆëŠ” ë¦¬ë·°ë“¤ë§Œ í•„í„°ë§
        if (filterByImage) {
            filteredReviews = filteredReviews.filter(review => review.review_photo);
        }
    
        // ë¦¬ë·° ì»¨í…Œì´ë„ˆë¥¼ ë¹„ìš°ê³  í•„í„°ë§ëœ ë¦¬ë·°ë“¤ì„ í‘œì‹œ
        review_container.innerHTML = '';
    
        filteredReviews.forEach(function(review) {
            // ì¹´ë“œ ìš”ì†Œ ìƒì„±
            var cardElement = document.createElement('div');
            cardElement.className = 'card';
            
            // ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„±
            var imgElement = document.createElement('img');
            imgElement.src = review.review_photo;
            imgElement.alt = 'Review Photo';
            imgElement.onerror = function() {
                this.onerror = null;
                this.src = '/static/img/default1.png';
            };
            imgElement.className = 'review-image';
            imgElement.onclick = function() {
                openModal(review.review_photo);
            };
            
            // ì¹´ë“œ ì½˜í…ì¸  ìš”ì†Œ ìƒì„±
            var cardContentElement = document.createElement('div');
            cardContentElement.className = 'card-content';
    
            // ë‚ ì§œ ìš”ì†Œ ìƒì„±
            var dateElement = document.createElement('p');
            dateElement.className = 'card-date';
    
            // ë°ì¼ë¦¬ íƒœê·¸ ìš”ì†Œ ìƒì„± (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
            if (review.daily_tag_name) {
                var dailyTagElement = document.createElement('p');
                dailyTagElement.className = 'card-daily';
                dailyTagElement.textContent = 'ë°©ë¬¸ ëª©ì : ' + review.daily_tag_name;
                cardContentElement.appendChild(dailyTagElement);
            }
    
            // ìœ„ë“œ íƒœê·¸ ìš”ì†Œ ìƒì„± (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
            if (review.with_tag_name) {
                var withTagElement = document.createElement('p');
                withTagElement.className = 'card-with';
                withTagElement.textContent = 'í•¨ê»˜ ë°©ë¬¸: ' + review.with_tag_name;
                cardContentElement.appendChild(withTagElement);
            }
    
            // ë¦¬ë·° í…ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„±
            var descriptionElement = document.createElement('p');
            descriptionElement.className = 'card-description';
            descriptionElement.textContent = review.review_text;
            
            // ì´ë¯¸ì§€ì™€ ì¹´ë“œ ì½˜í…ì¸ ë¥¼ ì¹´ë“œì— ì¶”ê°€
            cardElement.appendChild(imgElement);
            cardElement.appendChild(cardContentElement);
            
            // ì¹´ë“œ ìš”ì†Œë¥¼ ë¦¬ë·° ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            review_container.appendChild(cardElement);
        });
    
        // ëª¨ë‹¬ ê¸°ëŠ¥ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ì¬ì—°ê²°
        initModalEvents();
    }
    function loadReviews(filter) {
    var url = "?place_id={{ place.place_id }}&array=" + filter;
    console.log("Sending request to:", url);  // ìš”ì²­ URLì„ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ í™•ì¸

    fetch(url, {
        method: "GET",
        headers: {
            "X-Requested-With": "XMLHttpRequest"  // AJAX ìš”ì²­ì„ì„ ëª…ì‹œ
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();  // ì‘ë‹µì„ JSONìœ¼ë¡œ ë³€í™˜
    })
    .then(data => {
        console.log("Received data:", data);  // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥

        var reviewContainer = document.getElementById("review_container");  // review-container -> review_container
        reviewContainer.innerHTML = "";  // ê¸°ì¡´ ë¦¬ë·° ì œê±°

        // ìƒˆë¡œìš´ ë¦¬ë·° ì¶”ê°€
        if (data.serialized_reviews.length > 0) {
            data.serialized_reviews.forEach(function(review) {
                var reviewElement = document.createElement("div");
                reviewElement.className = "card";
                reviewElement.innerHTML = `
                    <img class="review-image" src="${review.review_photo}" alt="{% static 'img/default1.png' %}" onerror="this.onerror=null; this.src='{% static 'img/default1.png' %}';">
                    <img class="icon-overlay" src="{% static 'img/enlarge.png' %}">
                    <div class="card-content">
                        <p class="card-date">${review.review_date}</p>
                        {% if lang == 'kor' %}
                                {% if review.daily_tag_name %}
                                    <p class="card-daily">ë°©ë¬¸ ëª©ì : ${ review.daily_tag_name }</p>
                                {% endif %}
                                {% if review.with_tag_name %}
                                    <p class="card-with">í•¨ê»˜ ë°©ë¬¸: ${ review.with_tag_name }</p>
                                {% endif %}
                        {% else %}
                            {% for review in reviews %}
                                {% if forloop.first %}
                                    {% if review.daily_tag_name != null %}
                                        <p class="card-daily">Purpose of Visit: ${ review.daily_tag_name }</p>
                                    {% endif %}
                                    {% if review.with_tag_name != null %}
                                        <p class="card-with">Type of Visit: ${ review.with_tag_name }</p>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% if lang == 'kor' %}
                            <p class="card-description">${ review.kor_review_text }</p>
                        {% else %}
                            <p class="card-description">${ review.eng_review_text }</p>
                        {% endif %}
                    </div>
                `;
                reviewContainer.appendChild(reviewElement);
            });
        } else {
            // í•„í„°ë§ëœ ë¦¬ë·°ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
            reviewContainer.innerHTML = "<div>No reviews available for this filter.</div>";
        }
         // ìƒˆë¡œìš´ ë¦¬ë·°ê°€ ì¶”ê°€ëœ í›„ ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸ ì¬ì—°ê²°
        initModalEvents();
    })
    .catch(error => {
        console.error("Error:", error);  // ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ë¬¸ì œ ë°œìƒ ì‹œ ì—ëŸ¬ ì¶œë ¥
    });
}


    
    
    </script>
    <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=md0r6k664v"></script>
    <script src="{% static 'js/review/review.js' %}"></script>
    {% endblock %}
    