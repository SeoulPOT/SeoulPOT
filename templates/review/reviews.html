{% extends 'base/base.html' %}
{% block title %}{{ place.place_name }} - ë¦¬ë·° í˜ì´ì§€{% endblock %}
{% load static %}
{% block content %}

<div class="container">
    <div class="left-content">
        <div id="left-box">
            {% for photo in profile_photo %}
            <img id="place_img" src="{{ photo }}" alt="{{ photo }}" onerror="this.onerror=null; this.src='{% static 'img/default1.png' %}';">
            {% endfor %}
            <div id="map" class="map" onclick="openMapModal()"></div> <!-- í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ -->
            <div id="mapModalContainer" class="hidden">
                <div id="mapModalContent">
                    <div id="largeMap" class="map"></div> <!-- í° ì§€ë„ë¥¼ í‘œì‹œí•  ê³µê°„ -->
                    <button class="overlay-button" onclick="closeMapModal()">&#10006;</button> <!-- ë‹«ê¸° ë²„íŠ¼ -->
                </div>
            </div>
            <div class = "address">
            <h2 id="place-name">{{ place.place_name }}</h2>   
            <p>ğŸ—ºï¸{{ place.place_address }}</p>
            </div>
            <a href="{{ place.place_place_url }}">{{ place.place_place_url }}</a>
            {% if total %}
                <p class = "profile">ğŸš©  {{ kor_place_tag }}</p>
                <p class = "profile">ğŸ“ ë¦¬ë·° {{ total }}ê°œ</p>
            {% endif %}
            {% if place.place_operating_hours %}
                <p class = "profile" style="white-space: pre-line;">â° {{ place.place_operating_hours }}</p>
            {% endif %}
            {% if place.place_phone %}
                <p class = "profile">ğŸ“ {{ place.place_phone }}</p>
            {% endif %}
            {% if place.place_entrance_fee %}
                <p class = "profile">ğŸª™ {{ place.place_entrance_fee }}</p>
            {% endif %}
            <p>{{ place.place_place_desc }}</p>
        </div>
    </div>

    <div class="right-content">
        <div class="theme-header">
            <div class="tag-box">
                {% if thema_name %}
                <span class="tag_name">í…Œë§ˆ</span>
                {% for theme in thema_name %}
                <span class="tag">{{ theme }}</span>
                {% endfor %}
                {% endif %}
            </div>
            <div class="dropdown">
                {% if feature_dict %}
                <span class="keyword">í‚¤ì›Œë“œ</span>
                <select id="feature-select">
                    {% for key, value in feature_dict.items %}
                    <option>{{ key }}: {{ value }}</option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>
        </div>
        <div class="stat-box">
            <h3>ê¸/ë¶€ì •</h3>
            <div class = "stat-details">
                <p>
                    <span class="positive-percentage">ê¸ì • {{ pos_ratio }}%</span>
                    <span class="neutral-percentage">ì¤‘ë¦½ {{neutral}} %</span> 
                    <span class="negative-percentage">ë¶€ì • {{ neg_ratio }}%</span>
                </p>
                <div class="progress-bar">
                    <div class="progress-bar-inner positive-bar" style="width: {{ pos_ratio }}%;"></div>
                    <div class="progress-bar-inner neutral-bar" style="width: {{ neutral }}%;"></div>
                    <div class="progress-bar-inner negative-bar" style="width: {{ neg_ratio }}%;"></div>
                </div>
                <p>
                    <span class="review-summary">{{total}}ê°œì˜ ë¦¬ë·° ì¤‘ {{pos}}ê°œì˜ ê¸ì • ë¦¬ë·°ë¥¼ ê°€ì¡Œì–´ìš”!</span>
                </p>
            </div>
        </div>
    
        <div class="stat-box">
            <h3>ê´‘ê³ ì„±</h3>
            <div class="stat-details">
                <p>ì‹¤ ì‚¬ìš©ì ë¦¬ë·° ë¹„ìœ¨</p>
                <div class="progress-bar">
                    <div class="progress-bar-inner advertisement-bar" style="width: {{ real_ratio }}%;"></div>
                </div>
                <p>
                    <span class="review-summary">{{total}}ê°œì˜ ë¦¬ë·° ì¤‘ {{ ad }}ê°œê°€ ê´‘ê³ ì„±ìœ¼ë¡œ ì˜ì‹¬ë¼ìš”. -.-</span>
                </p>
            </div>
        </div>
    
        <div class="footer">
                <div class="reps-image">
                    <p>ëŒ€í‘œì‚¬ì§„</p>
                    <div class = "image-grid">
                    {% for photo in review_photos %}
                        <img src="{{ photo }}" alt="Review Photo">
                    {% endfor %}
                    </div>
                </div>
            <div class="review-list">
                <div class="filter-buttons">
                    <button onclick="loadReviews('latest')">ìµœì‹ ìˆœ âŒ›</button>
                    <button onclick="loadReviews('positive')">ê¸ì • ğŸ‘</button>
                    <button onclick="loadReviews('negative')">ë¶€ì • ğŸ‘</button>
                </div>
                <ul class="reviews" id="review-container">
                    {% for review in reviews %}
                    <li>
                        <span>{{ review.kor_review_text }}</span>
                        <span class="date">{{ review.review_date|date:"Y-m-d" }}</span>
                    </li>
                    {% endfor %}
                </ul>
                <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
                <a href="{% url 'reviews_more' lang %}?place_id={{ place.place_id }}" class = "more-link">
                    {% if lang == 'kor' %}
                        ë”ë³´ê¸° >
                    {% else %}
                        more > 
                    {% endif %}
                </a>
            </div>
        </div>
    </div>

    


{% endblock %}

{% block extra_css %}

<style>
.right-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 50%;
}

#mapModalContainer {
    width: 100%;
    height: 100%;
    position: fixed;
    top: 0;
    left: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

#mapModalContent {
    width: 80%;
    height: 80%;
    background-color: transparent; /* ë°°ê²½ ìƒ‰ìƒì„ íˆ¬ëª…í•˜ê²Œ ì²˜ë¦¬í•˜ì—¬ ì§€ë„ê°€ ì „ì²´ë¥¼ ì±„ìš°ë„ë¡ ì„¤ì • */
    position: relative;
}

#largeMap {
    width: 100%;
    height: 100%;
    border-radius: 10px;
}


#mapModalContainer.hidden {
    display: none;
}

</style>
<!-- ì´ í˜ì´ì§€ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” CSS -->
<link rel="stylesheet" href="{% static 'css/review/style.css' %}">
{% endblock %}


{% block extra_js %}
<script>
    const place_lat = {{place.place_lat}};
    const place_lon = {{place.place_lon}};
    const place_id = {{place.place_id}};
    let sort_array = '{{array}}';
    const marker_img = "{% static 'img/marker_img.png' %}";
    const current_page = {{current_page}};
    const total_pages = {{total_pages}};

    function initModalEvents() {
    const modalOpenButtons = document.querySelectorAll('.open-modal-button');
    modalOpenButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const imageSrc = e.target.getAttribute('data-image-src');
            openModal(imageSrc);
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initModalEvents();
});

function movePage(page, array) {
    fetch(`?place_id=${place_id}&page=${page}&array=${array}`, {
        method: "GET",
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(Response => Response.json())
    .then(data => {
        SetPagination(data.current_page, data.total_pages);
        SetReviews(data.reviews);
        initModalEvents(); // í˜ì´ì§€ê°€ ì´ë™í•œ í›„ì—ë„ ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ì—°ê²°
    })
    .catch(error => {
        console.error('Failed to load review data:', error);
    });
}

    // ëª¨ë‹¬ ì—´ê¸° ë° ë‹«ê¸°
function openModal(imageSrc) {
        const modal = document.getElementById('modalContainer');
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageSrc;
        modal.classList.remove('hidden');
    }

    function closeModal(){
        const modal = document.getElementById('modalContainer');
        modal.classList.add('hidden');
    }
    function openMapModal() {
    const mapModal = document.getElementById('mapModalContainer');
    mapModal.classList.remove('hidden');

    // í° ì§€ë„ í‘œì‹œ
    var largeMapOptions = {
        center: new naver.maps.LatLng(place_lat, place_lon), // ì¥ì†Œ ì¤‘ì‹¬ ìœ„ì¹˜
        zoom: 17
    };

    var largeMap = new naver.maps.Map('largeMap', largeMapOptions);

    var marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(place_lat, place_lon), // ë§ˆì»¤ ìœ„ì¹˜
        map: largeMap,
        icon: marker_img,
    });
}

function closeMapModal(){
    const mapModal = document.getElementById('mapModalContainer');
    mapModal.classList.add('hidden');
}
let reviewsData = []; // ì „ì²´ ë¦¬ë·° ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
let filterByImage = false; // ì´ë¯¸ì§€ í•„í„° ì—¬ë¶€ë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¦¬ë·° ë°ì´í„°ë¥¼ ì„¸íŒ…í•˜ëŠ” í•¨ìˆ˜
function SetReviews(reviews) {
    reviewsData = reviews; // ë¦¬ë·° ë°ì´í„°ë¥¼ ì €ì¥
    renderReviews(); // ì €ì¥ëœ ë¦¬ë·° ë°ì´í„°ë¥¼ ë Œë”ë§
}

// í•„í„°ë§ê³¼ ì •ë ¬ì„ í•¨ê»˜ ì ìš©í•œ ë¦¬ë·° ë Œë”ë§ í•¨ìˆ˜
function renderReviews() {
    let filteredReviews = reviewsData;

    // ì´ë¯¸ì§€ í•„í„°ê°€ í™œì„±í™”ë˜ë©´ ì´ë¯¸ì§€ê°€ ìˆëŠ” ë¦¬ë·°ë“¤ë§Œ í•„í„°ë§
    if (filterByImage) {
        filteredReviews = filteredReviews.filter(review => review.review_photo);
    }

    // ë¦¬ë·° ì»¨í…Œì´ë„ˆë¥¼ ë¹„ìš°ê³  í•„í„°ë§ëœ ë¦¬ë·°ë“¤ì„ í‘œì‹œ
    review_container.innerHTML = '';

    filteredReviews.forEach(function(review) {
        // ì¹´ë“œ ìš”ì†Œ ìƒì„±
        var cardElement = document.createElement('div');
        cardElement.className = 'card';
        
        // ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„±
        var imgElement = document.createElement('img');
        imgElement.src = review.review_photo;
        imgElement.alt = 'Review Photo';
        imgElement.onerror = function() {
            this.onerror = null;
            this.src = '/static/img/default1.png';
        };
        imgElement.className = 'review-image';
        imgElement.onclick = function() {
            openModal(review.review_photo);
        };
        
        // ì¹´ë“œ ì½˜í…ì¸  ìš”ì†Œ ìƒì„±
        var cardContentElement = document.createElement('div');
        cardContentElement.className = 'card-content';

        // ë‚ ì§œ ìš”ì†Œ ìƒì„±
        var dateElement = document.createElement('p');
        dateElement.className = 'card-date';

        // ë°ì¼ë¦¬ íƒœê·¸ ìš”ì†Œ ìƒì„± (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
        if (review.daily_tag_name) {
            var dailyTagElement = document.createElement('p');
            dailyTagElement.className = 'card-daily';
            dailyTagElement.textContent = 'ë°©ë¬¸ ëª©ì : ' + review.daily_tag_name;
            cardContentElement.appendChild(dailyTagElement);
        }

        // ìœ„ë“œ íƒœê·¸ ìš”ì†Œ ìƒì„± (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
        if (review.with_tag_name) {
            var withTagElement = document.createElement('p');
            withTagElement.className = 'card-with';
            withTagElement.textContent = 'í•¨ê»˜ ë°©ë¬¸: ' + review.with_tag_name;
            cardContentElement.appendChild(withTagElement);
        }

        // ë¦¬ë·° í…ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„±
        var descriptionElement = document.createElement('p');
        descriptionElement.className = 'card-description';
        descriptionElement.textContent = review.review_text;
        
        // ì´ë¯¸ì§€ì™€ ì¹´ë“œ ì½˜í…ì¸ ë¥¼ ì¹´ë“œì— ì¶”ê°€
        cardElement.appendChild(imgElement);
        cardElement.appendChild(cardContentElement);
        
        // ì¹´ë“œ ìš”ì†Œë¥¼ ë¦¬ë·° ì»¨í…Œì´ë„ˆì— ì¶”ê°€
        review_container.appendChild(cardElement);
    });

    // ëª¨ë‹¬ ê¸°ëŠ¥ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ì¬ì—°ê²°
    initModalEvents();
}
function loadReviews(filter) {
    var url = "?place_id={{ place.place_id }}&array=" + filter;

    fetch(url, {
        method: "GET",
        headers: {
            "X-Requested-With": "XMLHttpRequest"  // AJAX ìš”ì²­ì„ì„ ëª…ì‹œ
        }
    })
    .then(response => response.json())  // ì‘ë‹µì„ JSONìœ¼ë¡œ ë³€í™˜
    .then(data => {
        var reviewContainer = document.getElementById("review-container");
        reviewContainer.innerHTML = "";  // ê¸°ì¡´ ë¦¬ë·° ì œê±°
        
        // ìƒˆë¡œìš´ ë¦¬ë·° ì¶”ê°€
        if (data.serialized_reviews.length > 0) {
            data.serialized_reviews.forEach(function(review) {
                var reviewElement = document.createElement("li");
                reviewElement.innerHTML = `
                    <span>${review.kor_review_text}</span>
                    <span class="date">${review.review_date}</span>
                `;
                reviewContainer.appendChild(reviewElement);
            });
        } else {
            // í•„í„°ë§ëœ ë¦¬ë·°ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
            reviewContainer.innerHTML = "<li>No reviews available for this filter.</li>";
        }
    })
    .catch(error => console.error("Error:", error));  // ì—ëŸ¬ ì²˜ë¦¬
}


</script>

<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=md0r6k664v"></script>
<script src="{% static 'js/review/review.js' %}"></script>
{% endblock %}
